<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>修改器材</title>
		<link rel="stylesheet" href="../lib/layui-v2.6.3/css/layui.css">
		<style>
			.required::before {
				content: "*";
				color: #ff0000;
				margin-right: 4px;
				font-weight: bold;				
			}
		</style>
	</head>
	<body>
		<fieldset class="layui-elem-field layui-field-title">
			<legend style="font-weight: bold;">修改器材</legend>
		</fieldset>
		<div class="layui-form">
			<div class="layui-form-item">
				<label class="layui-form-label required">器材名称</label>
				<div class="layui-input-block">
					<select lay-verify="required" id="equipmentName">
						<option value="">请选择器材名称</option>
						<option value="1">跑步机</option>
						<option value="2" selected>瑜伽球</option>
						<option value="3">动感单车</option>
						<option value="4">哑铃</option>
						<option value="5" disabled>其他器材敬请期待</option>
					</select>
				</div>
			</div>
			
			<div class="layui-form-item">
			    <label class="layui-form-label required">购买日期</label>
			    <div class="layui-input-block" style="width: 1425px;">
			      <input type="text" class="layui-input" id="birthday" placeholder="yyyy-MM-dd" value="2024-07-21">
			    </div>
			  </div>
			
			<div class="layui-form-item">
				<label class="layui-form-label required">单价</label>
				<div class="layui-input-block">
				<input id="price" type="text" name="price" class="layui-input" lay-verify="required"
					lay-reqtext="单价不能为空!" placeholder="请输入单价" value="100">
					</div>
			</div>
			
			<div class="layui-form-item">
				<label class="layui-form-label required">使用寿命</label>
				<div class="layui-input-block">
				<input id="year" type="text" name="year" class="layui-input" lay-verify="required"
					lay-reqtext="使用寿命不能为空!" placeholder="请输入使用寿命" value="5年">
					</div>
			</div>
			
			<div class="layui-form-item">
				<label class="layui-form-label required">放置位置</label>
				<div class="layui-input-block">
				   <input id="place" type="text" name="place" class="layui-input" lay-verify="required"
					lay-reqtext="场地不能为空!" placeholder="请输入放置位置" value="瑜伽室A">
				</div>
			</div>
			
			<div class="layui-form-item">
			   <label class="layui-form-label required">状态</label>
			   <div class="layui-input-block">
			       <input type="checkbox" name="status" lay-skin="switch" lay-filter="switchTest" lay-text="正常|报废" checked>
			   </div>
			</div>

			<div class="layui-form-item">
				<label class="layui-form-label required">器材图片:</label><br>
				<div class="layui-input-block">
					<button type="button" class="layui-btn" id="ID-upload-demo-btn">
					  <i class="layui-icon layui-icon-upload"></i> 单图片上传
					</button>
					<div style="width: 132px;">
					  <div class="layui-upload-list">
					    <img class="layui-upload-img" id="ID-upload-demo-img" style="width: 100%; height: 92px;">
					    <div id="ID-upload-demo-text"></div>
					  </div>
					  <div class="layui-progress layui-progress-big" lay-showPercent="yes" lay-filter="filter-demo">
					    <div class="layui-progress-bar" lay-percent=""></div>
					  </div>
					</div>
				</div>
			</div>

			<hr style="margin: 21px 0;">
			
			<!-- 多图片上传布局修改 -->
			<div class="layui-form-item">
				<label class="layui-form-label">多图片上传</label>
				<div class="layui-input-block">
					<div class="layui-upload">
					  <button type="button" class="layui-btn" id="ID-upload-demo-btn-2">
					    <i class="layui-icon layui-icon-upload"></i> 多图片上传
					  </button> 
					  <blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 11px;">
					    预览图：
					    <div class="layui-upload-list" id="upload-demo-preview"></div>
					 </blockquote>
					</div>
				</div>
			</div>
			
			<div class="layui-form-item">
				<label class="layui-form-label required">操作说明</label>
				<div class="layui-input-block">
					<textarea  id="tip" name="tip" class="layui-textarea" lay-verify="required"
					lay-reqtext="操作说明不能为空!" placeholder="请输入操作说明（不超过500字）">注意安全，不要损坏器材</textarea>
				</div>
			</div> 
			
			<div class="layui-form-item">
				<div class="layui-input-block">
					<button class="layui-btn layui-btn-normal" lay-submit lay-filter="saveBtn">确认保存</button>
				</div>
			</div>
			
		</div>	
		<script src="../lib/layui-v2.6.3/layui.js"></script>
		<script>
		  layui.use(function(){
		    var laydate = layui.laydate;
		    // 购买日期选择器
		    laydate.render({
		      elem: '#birthday',
		      format: 'yyyy-MM-dd',
		      placeholder: 'yyyy-MM-dd',
		      done: function(value){
		        // 选择日期后自动校验非空
		        if(!value) layer.tips('购买日期不能为空', '#birthday', {tips: 1});
		      }
		    });
		  });
		</script>
		<script>
			// 表单验证核心逻辑（修复语法错误和逻辑顺序）
			layui.use(['form', 'layer'], function() {
			  var form = layui.form; 
			  var layer = layui.layer; 
			  $ = layui.$; 
			
			  // 1. 失去焦点验证（实时反馈）
			  // 器材名称验证
			  $("#equipmentName").blur(function() {
			    var val = $(this).val().trim();
			    if (!val) layer.msg('请选择器材名称', {icon: 0, time: 1500});
			  });
			
			  // 单价验证（数字+正数）
			  $("#price").blur(function() {
			    var val = $(this).val().trim();
			    if (!val) {
			      layer.msg('单价不能为空', {icon: 0, time: 1500});
			    } else if (isNaN(val) || parseFloat(val) <= 0) {
			      layer.msg('单价必须是正数', {icon: 0, time: 1500});
			    }
			  });
			
			  // 放置位置验证
			  $("#place").blur(function() {
			    var val = $(this).val().trim();
			    if (!val) layer.msg('放置位置不能为空', {icon: 0, time: 1500});
			  });
			
			  // 使用寿命验证
			  $("#year").blur(function() {
			    var val = $(this).val().trim();
			    if (!val) layer.msg('使用寿命不能为空', {icon: 0, time: 1500});
			  });
			
			  // 操作说明验证（非空+长度）
			  $("#tip").blur(function() {
			    var val = $(this).val().trim();
			    if (!val) {
			      layer.msg('操作说明不能为空', {icon: 0, time: 1500});
			    } else if (val.length > 500) {
			      layer.msg('操作说明不能超过500个字符', {icon: 0, time: 1500});
			    }
			  });
			
			  // 购买日期验证
			  $("#birthday").blur(function() {
			    var val = $(this).val().trim();
			    if (!val) layer.msg('购买日期不能为空', {icon: 0, time: 1500});
			  });
			
			  // 2. 表单提交总验证（修复原代码if-else语法错误）
			  form.on('submit(saveBtn)', function(data) {
			    // 初始化验证状态和错误信息
			    var isValid = true;
			    var errorMsg = '';
			
			    // 2.1 验证器材名称
			    if (!$("#equipmentName").val().trim()) {
			      isValid = false;
			      errorMsg = '请选择器材名称';
			    }
			    // 2.2 验证购买日期
			    else if (!$("#birthday").val().trim()) {
			      isValid = false;
			      errorMsg = '购买日期不能为空';
			    }
			    // 2.3 验证单价（数字+正数）
			    else if (!$("#price").val().trim()) {
			      isValid = false;
			      errorMsg = '单价不能为空';
			    } else if (isNaN($("#price").val().trim()) || parseFloat($("#price").val().trim()) <= 0) {
			      isValid = false;
			      errorMsg = '单价必须是正数';
			    }
			    // 2.4 验证使用寿命
			    else if (!$("#year").val().trim()) {
			      isValid = false;
			      errorMsg = '使用寿命不能为空';
			    }
			    // 2.5 验证放置位置
			    else if (!$("#place").val().trim()) {
			      isValid = false;
			      errorMsg = '放置位置不能为空';
			    }
			    // 2.6 验证操作说明（非空+长度）
			    else if (!$("#tip").val().trim()) {
			      isValid = false;
			      errorMsg = '操作说明不能为空';
			    } else if ($("#tip").val().trim().length > 500) {
			      isValid = false;
			      errorMsg = '操作说明不能超过500个字符';
			    }
			    // 2.7 验证单图片上传（保持原逻辑不变）
			    else if (!$("#ID-upload-demo-img").attr('src') || $("#ID-upload-demo-img").attr('src') === '') {
			      isValid = false;
			      errorMsg = '请上传器材图片';
			    }
			
			    // 3. 验证结果处理
			    if (!isValid) {
			      layer.msg(errorMsg, {icon: 0, time: 2000});
			      return false; // 阻止表单提交
			    }
			
			    // 4. 验证通过：显示提交信息（后续可对接ajax提交）
			    var index = layer.alert(JSON.stringify(data.field, null, 2), {
			      title: '最终的提交信息',
			      area: ['500px', '400px'],
			      btn: ['确认提交', '取消'],
			      yes: function() {
			        // 这里可补充ajax提交逻辑（示例）
			        /*
			        $.ajax({
			          url: '你的接口地址',
			          type: 'POST',
			          data: data.field,
			          dataType: 'json',
			          success: function(res) {
			            if (res.code === 0) {
			              layer.msg('提交成功', {icon: 1, time: 1500}, function() {
			                layer.close(index);
			                // 关闭iframe（如果是弹窗）
			                var iframeIndex = parent.layer.getFrameIndex(window.name);
			                parent.layer.close(iframeIndex);
			                // 刷新父页面列表（可选）
			                parent.location.reload();
			              });
			            } else {
			              layer.msg(res.msg, {icon: 2});
			            }
			          },
			          error: function() {
			            layer.msg('网络错误，请重试', {icon: 2});
			          }
			        });
			        */
			        // 暂不提交，仅关闭弹窗（测试用）
			        layer.close(index);
			        var iframeIndex = parent.layer.getFrameIndex(window.name);
			        parent.layer.close(iframeIndex);
			      }
			    });
			    return false; // 阻止layui默认提交
			  });
			});
			
			// 图片上传逻辑（保持原代码不变）
			layui.use(function(){
			  var upload = layui.upload;
			  var layer = layui.layer;
			  var element = layui.element;
			  var $ = layui.$;
			
			  // 单图片上传
			  var uploadInst = upload.render({
			    elem: '#ID-upload-demo-btn',
			    url: '', // 实际项目中替换为你的上传接口
			    accept: 'images',
			    acceptMime: 'image/*',
			    exts: 'jpg|jpeg|png|gif',
			    before: function(obj){
			      obj.preview(function(index, file, result){
			        $('#ID-upload-demo-img').attr('src', result); 
			      });
			      element.progress('filter-demo', '0%'); 
			      layer.msg('上传中', {icon: 16, time: 0});
			    },
			    done: function(res){
			      if(res.code > 0){
			        return layer.msg('上传失败');
			      }
			      $('#ID-upload-demo-text').html(''); 
			      layer.msg('上传成功', {icon: 1});
			    },
			    error: function(){
			      var demoText = $('#ID-upload-demo-text');
			      demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload">重试</a>');
			      demoText.find('.demo-reload').on('click', function(){
			        uploadInst.upload();
			      });
			    },
			    progress: function(n, elem, e){
			      element.progress('filter-demo', n + '%'); 
			      if(n == 100){
			        layer.msg('上传完毕', {icon: 1});
			      }
			    }
			  });
			
			  // 多图片上传
			  upload.render({
			    elem: '#ID-upload-demo-btn-2',
			    url: '', // 实际项目中替换为你的上传接口
			    multiple: true,
			    accept: 'images',
			    acceptMime: 'image/*',
			    exts: 'jpg|jpeg|png|gif',
			    before: function(obj){
			      obj.preview(function(index, file, result){
			        $('#upload-demo-preview').append('<img src="'+ result +'" alt="'+ file.name +'" style="width: 90px; height: 90px; margin: 5px;">')
			      });
			    },
			    done: function(res){
			      layer.msg('多图上传成功', {icon: 1});
			    },
			    error: function(){
			      layer.msg('多图上传失败', {icon: 2});
			    }
			  });
			});
		</script>
	</body>
</html>